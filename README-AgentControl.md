# Monitoring Agent Control Center

A professional PowerShell script for managing Monitoring Agent Windows with comprehensive enrollment, configuration, and control capabilities, including **automatic startup management**.

## Features

- **Agent Enrollment**: Easy setup with manager IP and client key configuration
- **Auto-Startup Management**: Integrated automatic startup after system boot, restart, or sleep
- **Task Scheduler Integration**: Uses Windows Task Scheduler for reliable auto-startup
- **Intelligent Watchdog**: Monitors agent status and restarts if stopped unexpectedly
- **Base64 Support**: Handles both plain text and base64 encoded client keys
- **Agent Control**: Start, stop, restart, and status monitoring
- **Configuration Management**: Automatic backup and update of configuration files
- **User-Friendly Interface**: Interactive menu system with colored output
- **Production Ready**: Comprehensive logging, error handling, and validation
- **Command Line Support**: Can be used both interactively and via command line

## Auto-Startup Features

The Control Center now includes **fully integrated auto-startup management**:

- **Seamless Integration**: Starting the agent automatically enables auto-startup; stopping disables it
- **Multiple Triggers**: Auto-starts after system boot, restart, wake from sleep, and user logon
- **Intelligent Monitoring**: Watchdog process monitors agent health and restarts if needed
- **Configurable Settings**: Customizable startup delays, restart limits, and monitoring intervals
- **Manual Override**: Option to manually manage auto-startup settings independent of agent status
- **Comprehensive Logging**: Detailed logs for all auto-startup activities and watchdog operations

## Requirements

- Windows PowerShell 5.1 or PowerShell Core 6+
- Administrator privileges
- Monitoring Agent installed in the same directory as the script

## Installation

1. Place the `MonitoringAgentControl.ps1` script in your Monitoring agent directory
2. Ensure you have the following files in the same directory:
   - `monitoring-agent.exe`
   - `ossec.conf`
   - `client.keys` (will be created during enrollment)

```bash
# Run Monitoring manager in single container
sudo docker run -d \
  --name monitoring-manager \
  -p 1514:1514/tcp \
  -p 1515:1515 \
  -p 514:514/udp \
  -p 55000:55000 \
  -e INDEXER_URL=https://wazuh.indexer:9200 \
  -e INDEXER_USERNAME=admin \
  -e INDEXER_PASSWORD=SecretPassword \
  -e FILEBEAT_SSL_VERIFICATION_MODE=full \
  wazuh/monitoring-manager:4.12.0
```

### Docker Manager Commands

```bash
# Check manager status
sudo docker ps | grep wazuh
### Viewing Manager Alerts (Docker)

To view alerts generated by the Monitoring manager inside the Docker container, you can use several approaches depending on whether you want to see raw alerts, follow them in real time, or query the manager API from inside the container.

- View recent alerts from the Wazuh log files inside the container (plain text):
  sudo docker exec -it monitoring-manager tail -n 200 /var/ossec/logs/alerts/alerts.log

- Follow alerts in real time:
  sudo docker exec -it monitoring-manager tail -n 100 -f /var/ossec/logs/alerts/alerts.log

- Pretty-print the last 50 alerts (if JSON output is available) using jq inside the container:
  sudo docker exec -it monitoring-manager bash -lc "tail -n 200 /var/ossec/logs/alerts/alerts.json 2>/dev/null | jq '.' | tail -n 50"

- Query the Wazuh API from inside the container (requires API service enabled):
  sudo docker exec -it monitoring-manager bash -lc "curl -s -u <user>:<pass> -k https://localhost:55000/alerts | jq '.'"

- Inspect the alerts directory directly (list files and sizes):
  sudo docker exec -it monitoring-manager ls -lh /var/ossec/logs/alerts/

Notes:
- Replace `monitoring-manager` with your container name if different.
- If your manager exposes ports and the API is reachable from the host, you can run the `curl` command directly from the host using the mapped port (e.g., `https://localhost:55000`).
- Not all Wazuh setups write JSON-formatted alerts to `alerts.json`; the default is `alerts.log`. Use the `ls` command above to check available files.

# View manager logs
sudo docker logs monitoring-manager

# Get manager IP (for agent enrollment)
sudo docker inspect monitoring-manager | grep IPAddress

# Access manager shell
sudo docker exec -it monitoring-manager /bin/bash

# Manage agents from Docker
sudo docker exec -it monitoring-manager /var/ossec/bin/manage_agents

# To see the List of Active Agents connected to the Manager
sudo docker exec -it monitoring-manager /var/ossec/bin/agent_control -l

# Stop manager
sudo docker stop monitoring-manager

# Start manager
sudo docker start monitoring-manager

# Remove manager (data will be lost)
sudo docker rm -f monitoring-manager
```

### Get Manager IP for Agent Enrollment

```bash
# Method 1: Docker inspect
MANAGER_IP=$(sudo docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' monitoring-manager)
echo "Manager IP: $MANAGER_IP"

# Method 2: Check all networks
sudo docker network ls
sudo docker network inspect bridge | grep -A 3 wazuh

# Method 3: Use localhost if port forwarding
MANAGER_IP="127.0.0.1"  # If using -p 1514:1514
```

---



## Usage

### Interactive Mode (Recommended)

Run the script without parameters to launch the interactive menu:

```powershell
# Run as Administrator
.\MonitoringAgentControl.ps1
```

### Command Line Mode

For automation and scripting:

```powershell
# Start the agent (automatically enables auto-startup)
.\MonitoringAgentControl.ps1 start

# Stop the agent (automatically disables auto-startup) 
.\MonitoringAgentControl.ps1 stop

# Restart the agent (maintains current auto-startup state)
.\MonitoringAgentControl.ps1 restart

# Check agent status (includes auto-startup information)
.\MonitoringAgentControl.ps1 status

# Start enrollment process
.\MonitoringAgentControl.ps1 enroll

# Auto-enrollment with agent-auth.exe
.\MonitoringAgentControl.ps1 auto-enroll

# Manual enrollment with pre-generated key
.\MonitoringAgentControl.ps1 manual-enroll

# Clean database files
.\MonitoringAgentControl.ps1 cleanup
```

**Note**: When using command line mode, auto-startup management is fully integrated. Starting the agent will automatically set up auto-startup tasks, and stopping will disable them.

## Interactive Menu Options

1. **Enroll Agent**: Configure connection to Monitoring manager
2. **Start Agent**: Start the Monitoring agent service (automatically enables auto-startup)
3. **Stop Agent**: Stop the Monitoring agent service (automatically disables auto-startup)
4. **Restart Agent**: Restart the agent service
5. **Check Agent Status**: View current agent status, connection, and auto-startup status
6. **View Recent Logs**: Display recent agent log entries
7. **Show Configuration**: Display current agent configuration
8. **Auto-Startup Management**: Manual control of auto-startup settings
9. **Clean Database Files**: Clean agent database files (with restart if needed)
0. **Exit**: Close the control center

## Auto-Startup Management

### Automatic Integration

The Control Center now **automatically manages auto-startup** when you start or stop the agent:

- **Starting the Agent** (`Option 2` or `.\MonitoringAgentControl.ps1 start`):
  - Automatically installs auto-startup tasks
  - Starts the watchdog monitoring service
  - Configures multiple startup triggers (boot, restart, wake, logon)

- **Stopping the Agent** (`Option 3` or `.\MonitoringAgentControl.ps1 stop`):
  - Automatically stops auto-startup tasks
  - Stops the watchdog monitoring service
  - Agent will not auto-start until manually started again

### Manual Auto-Startup Control (Option 8)

For advanced users who want manual control over auto-startup settings:

```
╔══════════════════════════════════════════════════════════════════════════════════════════════════════════════
║                                    AUTO-STARTUP MANAGEMENT                                                  ║
╠══════════════════════════════════════════════════════════════════════════════════════════════════════════════
║  1. Install Auto-Startup Tasks     - Enable automatic startup after system events                          ║
║  2. Remove Auto-Startup Tasks      - Disable automatic startup                                              ║
║  3. Start Auto-Startup Tasks       - Start auto-startup services (if installed)                            ║
║  4. Stop Auto-Startup Tasks        - Stop auto-startup services (keeps tasks installed)                    ║
║  5. Show Auto-Startup Status       - Display current auto-startup configuration                            ║
║  0. Return to Main Menu            - Go back to main menu                                                  ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════════════
```

### Auto-Startup Features

- **Multiple Triggers**: 
  - System startup/boot
  - System restart
  - Wake from sleep/hibernation
  - User logon

- **Intelligent Watchdog**:
  - Monitors agent every 30 seconds
  - Automatically restarts if agent stops unexpectedly
  - Configurable restart limits (default: 5 attempts per hour)
  - Comprehensive logging of all restart activities

- **Startup Configuration**:
  - Configurable startup delay (default: 30 seconds after trigger)
  - Runs with highest privileges and priority
  - Starts even if no user is logged in
  - Compatible with fast startup and hibernation

### Status Information

The `Check Agent Status` option now includes auto-startup information:

```powershell
=== MONITORING AGENT STATUS ===
Agent Status: Running (PID: 12345)
Agent State: Connected to manager
Uptime: 2 hours 30 minutes

=== AUTO-STARTUP STATUS ===
Tasks Installed: Yes
Tasks Running: Yes
Watchdog Status: Running (PID: 67890)
Last Startup: 2025-01-22 08:30:15
Restart Count: 0
```

## Enrollment Process

The enrollment process guides you through:

1. **Manager Configuration**:
   - Enter Monitoring manager IP address or hostname
   - Specify manager port (default: 1514)

2. **Client Key Setup**:
   - Provide client key obtained from the manager
   - Supports both plain text and base64 encoded keys
   - Automatic format validation

3. **Configuration Update**:
   - Automatic backup of existing configuration
   - Update `ossec.conf` with manager details
   - Update `client.keys` with agent credentials

4. **Agent Startup**:
   - Option to start agent immediately after enrollment
   - Connection status verification

## Client Key Formats

### Plain Text Format
```
001 AGENT-NAME any 1234567890abcdef1234567890abcdef12345678
```

### Base64 Encoded Format
The script automatically detects and can decode base64 encoded keys.

## Configuration Files

### ossec.conf Updates
The script automatically updates:
- Manager IP address (`<address>`)
- Manager port (`<port>`)

### client.keys Format
```
ID NAME IP KEY
```
Example:
```
001 DESKTOP-IVBQT1T any 70fea647733e1339286489e9b4f6c132df186bbad13c74e43577268ecaa01990
```

## Logging

- **Console Output**: Colored status messages for easy reading
- **Log File**: Detailed logging to `logs\agent-control.log`
- **Backup Files**: Automatic configuration backups with timestamps

## Error Handling

The script includes comprehensive error handling for:
- Invalid IP addresses or hostnames
- Malformed client keys
- Configuration file access issues
- Agent startup/shutdown problems
- Network connectivity issues

## Status Indicators

### Agent Status
- **RUNNING**: Agent process is active
- **STOPPED**: Agent is not running
- **Connected**: Agent is communicating with manager
- **DISCONNECTED**: Agent cannot reach manager
- **UNKNOWN**: Connection status uncertain

### Connection Verification
The script checks:
- Agent process status
- Recent log entries for connectivity
- Agent state file information

## Security Features

- **Secure Input**: Client keys are hidden during input
- **Backup Protection**: Automatic configuration backups
- **Admin Validation**: Requires administrator privileges
- **Key Validation**: Validates client key format

## Troubleshooting

### Common Issues

1. **"Access Denied" Error**
   - Solution: Run PowerShell as Administrator

2. **"Agent executable not found"**
   - Solution: Ensure script is in the Monitoring agent directory

3. **"Connection failed"**
   - Check manager IP and port
   - Verify firewall settings
   - Confirm manager is running

4. **"Invalid client key"**
   - Verify key format (ID NAME IP KEY)
   - Check for extra spaces or characters
   - Ensure key was copied correctly from manager

### Auto-Startup Troubleshooting

5. **Auto-startup not working after reboot**
   - Check if tasks are installed: Use Option 8 → Option 5
   - Verify Task Scheduler service is running: `Get-Service Schedule`
   - Review startup logs in the `logs/` directory
   - Ensure script path hasn't changed

6. **Watchdog not restarting agent**
   - Check watchdog process: Look for `MonitoringAgentWatchdog.ps1` in Task Manager
   - Review watchdog logs: Check `logs/watchdog.log`
   - Verify restart limits haven't been exceeded
   - Ensure agent is properly stopped before watchdog attempts restart

7. **Tasks installed but not starting**
   - Check task status: `Get-ScheduledTask -TaskName "MonitoringAgent*"`
   - Verify task execution settings: Open Task Scheduler and check task properties
   - Review system event logs: Check Windows Event Viewer for task scheduler errors
   - Ensure tasks have proper permissions: Tasks should run as SYSTEM

8. **Agent starts but auto-startup status shows as disabled**
   - Restart the Control Center script
   - Check if tasks were installed in a different user context
   - Verify script is running with Administrator privileges
   - Use Option 8 → Option 1 to reinstall auto-startup tasks

### Auto-Startup Log Locations

- **Agent Logs**: `logs/service.log`
- **Watchdog Logs**: `logs/watchdog.log`
- **Task Scheduler Logs**: Windows Event Viewer → Task Scheduler Operational
- **Agent Control Logs**: Current directory (timestamped entries)

### Log Locations

- **Agent Logs**: `logs\ossec.log`
- **Control Script Logs**: `logs\agent-control.log`
- **Configuration Backups**: `*.backup_YYYYMMDD_HHMMSS`

## Advanced Configuration

### Custom Manager Ports
The script supports custom manager ports. Standard ports:
- **1514**: Default Monitoring manager port
- **1515**: Alternative port for encrypted communications

### Network Validation
The script performs:
- IP address format validation
- Hostname resolution testing
- Base64 encoding detection

## Examples

### Example 1: First-time Setup
```powershell
# 1. Run the script as Administrator
.\MonitoringAgentControl.ps1

# 2. Select option 1 (Enroll Agent)
# 3. Enter manager IP: 192.168.1.100
# 4. Enter port: 1514 (or press Enter for default)
# 5. Enter client key from manager
# 6. Confirm configuration
# 7. Start agent when prompted
```

### Example 2: Automated Restart
```powershell
# Stop, wait, and start agent
.\MonitoringAgentControl.ps1 stop
Start-Sleep -Seconds 5
.\MonitoringAgentControl.ps1 start
```

### Example 3: Status Check in Script
```powershell
$Status = & .\MonitoringAgentControl.ps1 status
if ($LASTEXITCODE -eq 0) {
    Write-Host "Agent is running properly"
} else {
    Write-Host "Agent has issues"
}
```

## Support

For issues with the control script:
1. Check the log files for detailed error messages
2. Verify all prerequisites are met
3. Ensure proper file permissions
4. Review the Monitoring agent documentation

## Version History

- **v1.0.0**: Initial release with full functionality
  - Interactive menu system
  - Command line support
  - Base64 key support
  - Comprehensive logging
  - Production-ready error handling

## License

This script is provided as-is for managing Monitoring Agent Windows. Use in accordance with your organization's security policies.